[gcode_macro _FILAMENT_VARS]
variable_nozzle_preheat_temp: 200 # Default preheat temperature for the nozzle
variable_min_temp: 200 # Safe minimun temperature for extrusion
variable_turn_off_extruder: True # Option to turn off the extruder after action (True/False)
gcode:
    # This macro only stores variables and should not be called directly
    M118 Do not call _FILAMENT_VARS directly

[gcode_macro _SAVE_FILAMENT_STATE]
gcode:
    # Save current state of the printer
    SAVE_GCODE_STATE NAME={params.STATE_NAME|default('filament_action_state')}

[gcode_macro _HEAT_NOZZLE_SAFE]
variable_target_temp: 0
variable_min_temp: 0
gcode:
    {% set target_temp = params.TARGET_TEMP|default(target_temp) %}
    {% set min_temp = params.MIN_TEMP|default(min_temp) %}

    # Set the effective temperature to heat to
    {% set effective_temp = target_temp if target_temp >= min_temp else min_temp %}

    # Heat directly to the effective temperature
    M104 S{effective_temp} ; Set extruder to effective temperature
    M109 S{effective_temp} ; Wait for extruder to reach effective temperature

[gcode_macro _RESTORE_FILAMENT_STATE]
variable_turn_off_extruder: False
gcode:
    {% set turn_off_extruder = params.TURN_OFF_EXTRUDER|default(turn_off_extruder) %}

    # Optionally turn off the extruder heater
    {% if turn_off_extruder %}
        M104 S0 ; Turn off extruder heater
    {% endif %}

    # Restore previous state of the printer
    G90 ; Restore absolute positioning
    RESTORE_GCODE_STATE NAME={params.STATE_NAME|default('filament_action_state')}

[gcode_macro LOAD_FILAMENT]
variable_load_distance: 380 # Distance to load filament into the extruder
variable_purge_distance: 50 # Distance to purge filament after loading

gcode:
    # Get common settings from the variables macro
    {% set settings = printer["gcode_macro _FILAMENT_VARS"] %}

    # Parameters and settings
    {% set load_speed = params.LOAD_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(300) %}
    {% set target_temp = params.TARGET_TEMP|default(settings.nozzle_preheat_temp) %}

    # Save current state of the printer
    _SAVE_FILAMENT_STATE STATE_NAME=load_state

    # Heat nozzle safely
    _HEAT_NOZZLE_SAFE TARGET_TEMP={target_temp} MIN_TEMP={settings.min_temp}

    # Begin filament loading process
    G91 ; Set relative positioning for extrusion
    G92 E0 ; Reset extruder position
    G1 E{load_distance} F{load_speed} ; Load filament at the specified loading speed
    G1 E{purge_distance} F{purge_speed} ; Purge filament at the slower purging speed

    # Restore previous state of the printer (including optionally turning off the heater)
    _RESTORE_FILAMENT_STATE STATE_NAME=load_state TURN_OFF_EXTRUDER={settings.turn_off_extruder}

    # Completion message
    M117 Filament load complete

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance: 380 # Distance to retract filament from the extruder

gcode:
    # Get common settings from the variables macro
    {% set settings = printer["gcode_macro _FILAMENT_VARS"] %}

    # Parameters and settings
    {% set retract_speed = params.RETRACT_SPEED|default(600) %}
    {% set target_temp = params.TARGET_TEMP|default(settings.nozzle_preheat_temp) %}

    # Save current state of the printer
    _SAVE_FILAMENT_STATE STATE_NAME=unload_state

    # Only heat if current temperature is too low for unloading
    {% if printer.extruder.temperature < target_temp %}
        # Heat nozzle safely
        _HEAT_NOZZLE_SAFE TARGET_TEMP={target_temp} MIN_TEMP={settings.min_temp}
    {% endif %}

    # Begin filament unloading process
    G91 ; Set relative positioning for extrusion
    G92 E0 ; Reset extruder position
    G1 E-{unload_distance} F{retract_speed} ; Retract filament at the specified speed

    # Restore previous state of the printer (including optionally turning off the heater)
    _RESTORE_FILAMENT_STATE STATE_NAME=unload_state TURN_OFF_EXTRUDER={settings.turn_off_extruder}

    # Completion message
    M117 Filament unload complete