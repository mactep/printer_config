[extruder]
max_extrude_only_distance: 400

[gcode_macro _FILAMENT_VARS]
variable_filament_distance:   400  # Common distance for both loading and unloading filament
variable_purge_distance:      50   # Distance to purge filament after loading
variable_nozzle_preheat_temp: 200  # Default preheat temperature for the nozzle
variable_min_temp:            200  # Safe minimum temperature for extrusion
variable_turn_off_extruder:   True # Option to turn off the extruder after action (True/False)
gcode:
    M118 Do not call _FILAMENT_VARS directly

[gcode_macro _SAVE_FILAMENT_STATE]
gcode:
    # Save current state, but EXCLUDE the extruder heater object
    SAVE_GCODE_STATE NAME={params.STATE_NAME|default('filament_action_state')} EXCLUDE_OBJECT=extruder

[gcode_macro _HEAT_NOZZLE_SAFE]
variable_target_temp: 0
variable_min_temp: 0
gcode:
    {% set target_temp = params.TARGET_TEMP|default(target_temp) %}
    {% set min_temp = params.MIN_TEMP|default(min_temp) %}

    # Set the effective temperature (ensures we heat above min_temp)
    {% set effective_temp = target_temp if target_temp >= min_temp else min_temp %}

    # 1. Set the target temperature (NON-BLOCKING)
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={effective_temp}
    
    # 2. Wait for the temperature to be reached (BLOCKING, necessary for safe loading)
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={effective_temp}

[gcode_macro _RESTORE_FILAMENT_STATE]
variable_turn_off_extruder: False
gcode:
    {% set turn_off_extruder = params.TURN_OFF_EXTRUDER|default(turn_off_extruder) %}

    # Optionally turn off the extruder heater using Klipper native command
    {% if turn_off_extruder %}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    {% endif %}

    # Restore previous state of the printer (Note: Extruder heater state is EXCLUDED)
    G90 ; Restore absolute positioning
    RESTORE_GCODE_STATE NAME={params.STATE_NAME|default('filament_action_state')}

[gcode_macro LOAD_FILAMENT]
gcode:
    # Get common settings from the variables macro
    {% set settings = printer["gcode_macro _FILAMENT_VARS"] %}

    # Parameters and settings
    {% set load_speed = params.LOAD_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(300) %}
    {% set target_temp = params.TARGET_TEMP|default(settings.nozzle_preheat_temp) %}

    # Save current state of the printer
    _SAVE_FILAMENT_STATE STATE_NAME=load_state

    # Heat nozzle safely
    _HEAT_NOZZLE_SAFE TARGET_TEMP={target_temp} MIN_TEMP={settings.min_temp}

    # Begin filament loading process
    G91 ; Set relative positioning for extrusion
    G92 E0 ; Reset extruder position
    G1 E{settings.filament_distance} F{load_speed} ; Load filament at the specified loading speed
    G1 E{settings.purge_distance} F{purge_speed} ; Purge filament at the slower purging speed

    # Restore previous state of the printer (including optionally turning off the heater)
    _RESTORE_FILAMENT_STATE STATE_NAME=load_state TURN_OFF_EXTRUDER={settings.turn_off_extruder}

    # Completion message
    M117 Filament load complete

[gcode_macro UNLOAD_FILAMENT]
gcode:
    # Get common settings from the variables macro
    {% set settings = printer["gcode_macro _FILAMENT_VARS"] %}

    # Parameters and settings
    {% set retract_speed = params.RETRACT_SPEED|default(600) %}
    {% set target_temp = params.TARGET_TEMP|default(settings.nozzle_preheat_temp) %}

    # Save current state of the printer
    _SAVE_FILAMENT_STATE STATE_NAME=unload_state

    # Only heat if current temperature is too low for unloading
    {% if printer.extruder.temperature < target_temp %}
        # Heat nozzle safely
        _HEAT_NOZZLE_SAFE TARGET_TEMP={target_temp} MIN_TEMP={settings.min_temp}
    {% endif %}

    # Begin filament unloading process
    G91 ; Set relative positioning for extrusion
    G92 E0 ; Reset extruder position
    G1 E-{settings.filament_distance} F{retract_speed} ; Retract filament at the specified speed

    # Restore previous state of the printer (including optionally turning off the heater)
    _RESTORE_FILAMENT_STATE STATE_NAME=unload_state TURN_OFF_EXTRUDER={settings.turn_off_extruder}

    CLEAR_ACTIVE_SPOOL ; remove selected filament from spoolman 

    # Completion message
    M117 Filament unload complete