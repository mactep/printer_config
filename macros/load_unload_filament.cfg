[extruder]
max_extrude_only_distance: 400

[gcode_macro _FILAMENT_VARS]
variable_filament_distance:   400  # Common distance for both loading and unloading filament
variable_purge_distance:      20   # Distance to purge filament after loading
variable_nozzle_preheat_temp: 200  # Default preheat temperature for the nozzle
variable_min_temp:            180  # Safe minimum temperature for extrusion
variable_turn_off_extruder:   True # Option to turn off the extruder after action (True/False)
gcode:
    M118 Do not call _FILAMENT_VARS directly

[gcode_macro LOAD_FILAMENT]
gcode:
    # Access variables from _FILAMENT_VARS directly in the gcode section
    {% set load_dist = printer["gcode_macro _FILAMENT_VARS"].filament_distance %}
    {% set purge_dist = printer["gcode_macro _FILAMENT_VARS"].purge_distance %}
    {% set default_temp = printer["gcode_macro _FILAMENT_VARS"].nozzle_preheat_temp %}
    {% set min_temp_var = printer["gcode_macro _FILAMENT_VARS"].min_temp %}
    {% set turn_off = printer["gcode_macro _FILAMENT_VARS"].turn_off_extruder %}

    # Parameters and settings - Use the accessed variables as the defaults
    {% set load_speed = params.LOAD_SPEED|default(600) %}
    {% set purge_speed = params.PURGE_SPEED|default(300) %}
    {% set target_temp = params.TARGET_TEMP|default(default_temp) %}
    {% set min_temp = params.MIN_TEMP|default(min_temp_var) %}

    # Save current state of the printer
    SAVE_GCODE_STATE NAME=load_state

    # Heat
    {% if target_temp >= min_temp %}
        M104 S{target_temp}
        M109 S{target_temp}
    {% else %}
        M104 S{min_temp}
        M109 S{min_temp}
    {% endif %}

    # Begin filament loading process
    G91
    G92 E0
    G1 E{load_dist} F{load_speed} ; Load filament
    G1 E{purge_dist} F{purge_speed} ; Purge filament

    # Optionally turn off the extruder heater after loading
    {% if turn_off %}
        M104 S0
    {% endif %}

    # Restore previous state of the printer
    G90
    RESTORE_GCODE_STATE NAME=load_state

    # Completion message
    M117 Filament load complete

[gcode_macro UNLOAD_FILAMENT]
gcode:
    # Access variables from _FILAMENT_VARS directly in the gcode section
    {% set unload_dist = printer["gcode_macro _FILAMENT_VARS"].filament_distance %}
    {% set default_temp = printer["gcode_macro _FILAMENT_VARS"].nozzle_preheat_temp %}
    {% set min_temp_var = printer["gcode_macro _FILAMENT_VARS"].min_temp %}
    {% set turn_off = printer["gcode_macro _FILAMENT_VARS"].turn_off_extruder %}

    # Parameters and settings - Use the accessed variables as the defaults
    {% set retract_speed = params.RETRACT_SPEED|default(600) %}
    {% set target_temp = params.TARGET_TEMP|default(default_temp) %}
    {% set min_temp = params.MIN_TEMP|default(min_temp_var) %}

    # Save current state of the printer
    SAVE_GCODE_STATE NAME=unload_state

    # Heat the nozzle
    {% if printer.extruder.temperature < target_temp %}
        {% if target_temp >= min_temp %}
            M104 S{target_temp}
            M109 S{target_temp}
        {% else %}
            M104 S{min_temp}
            M109 S{min_temp}
        {% endif %}
    {% endif %}

    # Begin filament unloading process
    G91
    G92 E0
    G1 E-{unload_dist} F{retract_speed} ; Retract filament

    # Optionally turn off the extruder heater after unloading
    {% if turn_off %}
        M104 S0
    {% endif %}

    # Restore previous state of the printer
    G90
    RESTORE_GCODE_STATE NAME=unload_state

    # If spoolman is active, clear the current spool
    {% if 'gcode_macro CLEAR_ACTIVE_SPOOL' in printer %}
        CLEAR_ACTIVE_SPOOL
        M118 Spoolman: Active spool cleared.
    {% endif %}

    # Completion message
    M117 Filament unload complete